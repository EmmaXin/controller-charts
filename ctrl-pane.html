<!DOCTYPE html>
<html>
<script src="./node_modules/angular/angular.js"></script>
<script src="./node_modules/chai/chai.js"></script>
<script src="./node_modules/chart.js/dist/Chart.js"></script>
<script src="./node_modules/jquery/dist/jquery.js"></script>

<link href="./node_modules/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
<link href="./node_modules/bootstrap/dist/css/bootstrap-theme.css.map" rel="stylesheet">

<style>
.controller-text span {
    font-size: 90%;
    font-weight: 700;
}

.controller-text :nth-child(1) {
    font-weight: 400;
}

</style>

<body>

<div ng-app="myApp" ng-controller="myCtrl">

    <div class="container">
        <div class="row" style="min-width: 800px">
            <div class="col-xs-8 col-md-8">
                <div class="panel panel-default">
                    <div class="panel-body" style="height: 350px">

                        <div ng-show="true" class="col-md-6">
                            <h4>{{controllers[0].name}}</h4>
                            <div class="row">
                                <div class="col-md-9">
                                    <canvas class="main-chart" id="controller-1-cpu-chart" width="300" height="150"></canvas>
                                </div>
                                <div class="col-md-3 controller-text">
                                    <span>CPU</span>
                                    <span>
                                        {{controllers[0].cpu.last().utilization}}%&nbsp;
                                        {{controllers[0].cpu.last().frequencyInGhz}}&nbsp;GHz
                                    </span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-9">
                                    <canvas class="main-chart" id="controller-1-memory-chart" width="300" height="150"></canvas>
                                </div>
                                <div class="col-md-3 controller-text">
                                    <span>Memory</span>
                                    <span>
                                        {{controllers[0].memory.last().usedInGb}}/{{controllers[0].memory.last().totalInGb}}&nbsp;GB&nbsp;
                                        ({{controllers[0].memory.last().utilization}}%)
                                    </span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-9">
                                    <canvas class="main-chart" id="controller-1-ethernet-chart" width="300" height="150"></canvas>
                                </div>
                                <div class="col-md-3 controller-text">
                                    <span>Ethernet</span>
                                    <span>
                                        S: {{controllers[0].ethernet.last().transmitInKbps}} R: {{controllers[0].ethernet.last().receiveInKbps}} Kbps
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div ng-show="true" class="col-md-6">
                            <h4 id="controller-2-name">Controller2</h4>
                            <div class="row">
                                <div class="col-md-9">
                                    <canvas class="main-chart" id="controller-2-cpu-chart" width="300" height="150"></canvas>
                                </div>
                                <div class="col-md-3 controller-text">
                                    <span>CPU</span>
                                    <span id="controller-2-cpu-value"></span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-9">
                                    <canvas class="main-chart" id="controller-2-memory-chart" width="300" height="150"></canvas>
                                </div>
                                <div class="col-md-3 controller-text">
                                    <span>Memory</span>
                                    <span id="controller-2-memory-value"></span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-9">
                                    <canvas class="main-chart" id="controller-2-ethernet-chart" width="300" height="150"></canvas>
                                </div>
                                <div class="col-md-3 controller-text">
                                    <span>Ethernet</span>
                                    <span id="controller-2-ethernet-value"></span>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="panel-footer">CONTROLLER</div>
                </div>

            </div>
        </div> <!-- row -->
    </div>

</div>

<script>
    function makeChart(ctx, opt) {
        return new Chart(ctx, opt);

//    return {
//      update: function () {
//      }
//    };
    }

    function makeLineChart(canvasContext) {
//    var _chartData = {
//        datasets: [
//          {data: (new Array(60)).fill(0)}
//        ]
//      },
//      _opt = {
//        data: _chartData
//      },
        var _info = {};

        var _chartData = {
            labels: (new Array(60)).fill(''),
            datasets: [{
                lineTension: 0,
                borderWidth: 1,
                pointRadius: 0,
                backgroundColor: "rgba(30, 191, 174, 0.2)",
                borderColor: "rgba(30, 191, 174, 1)",
                pointBorderColor: "rgba(30, 191, 174, 1)",
                label: 'CPU',
                data: (new Array(60)).fill(0)
            }]
        };

        var _opt = {
            type: 'line',
            data: _chartData,
            options: {
                animation : false,
                scales: {
                    xAxes: [{
                        display: false
                    }],
                    yAxes: [{
                    }]
                },
                legend: {
                    display: false
                },
                tooltips: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return tooltipItem.yLabel;
                        }
                    }
                }
            }
        };

        return {
            chart: makeChart(canvasContext, _opt),
            update: function (data) {
                var chartData = _chartData.datasets[0].data;
                angular.forEach(chartData, function (el, index, array) {
                    if (index !== 0) {
                        array[index - 1] = el;
                    }
                });
                chartData[chartData.length - 1] = data.utilization;
                this.chart.update();

                _info = data;
            },
            reset: function () {
                var chartData = _chartData.datasets[0].data;
                angular.forEach(chartData, function (el, index, array) {
                    array[index] = 0;
                });
            },
            chartLast: function (n) {
                n = n || 1;
                var chartData = _chartData.datasets[0].data;

                if (chartData.length < n) {
                    n = chartData.length;
                }

                return chartData.slice(chartData.length - n, chartData.length)
                    .reverse();
            },
            last: function () {
                return _info;
            }
        };
    }

    function makeStackChart(canvasContext) {
//    var _chartData = {
//        datasets: [
//          {data: (new Array(60)).fill(0)},
//          {data: (new Array(60)).fill(0)}
//        ]
//      },
//      _opt = {
//        data: _chartData
//      },
        var _info = {};

        var _chartData = {
            labels: (new Array(60)).fill(''),
            datasets: [{
                lineTension: 0.1,
                pointRadius: 0,
                backgroundColor: "rgba(71, 209, 71, 0.3)",
                borderColor: "rgba(71, 209, 71, 1)",
                pointBorderColor: "rgba(71, 209, 71, 1)",
                label: 'Send',
                data: (new Array(60)).fill(0)
            }, {
                lineTension: 0.1,
                pointRadius: 0,
                backgroundColor: "rgba(48, 165, 255, 0.2)",
                borderColor: "rgba(48, 165, 255, 1)",
                pointBorderColor: "rgba(48, 165, 255, 1)",
                label: 'Receive',
                data: (new Array(60)).fill(0)
            }]
        };

        var _opt = {
            type: 'line',
            data: _chartData,
            options: {
                animation : false,
                scales: {
                    xAxes: [{
                        display: false,
                        stacked: true
                    }],
                    yAxes: [{
                        stacked: true
                    }]
                }
            }
        };

        return {
            chart: makeChart(canvasContext, _opt),
            update: function (data) {
                var chartData = _chartData.datasets[0].data;
                angular.forEach(chartData, function (el, index, array) {
                    if (index !== 0) {
                        array[index - 1] = el;
                    }
                });
                chartData[chartData.length - 1] = data.transmitInKbps;

                chartData = _chartData.datasets[1].data;
                angular.forEach(chartData, function (el, index, array) {
                    if (index !== 0) {
                        array[index - 1] = el;
                    }
                });
                chartData[chartData.length - 1] = data.receiveInKbps;
                this.chart.update();

                _info = data;
            },
            reset: function () {
                var chartData = _chartData.datasets[0].data;
                angular.forEach(chartData, function (el, index, array) {
                    array[index] = 0;
                });

                chartData = _chartData.datasets[1].data;
                angular.forEach(chartData, function (el, index, array) {
                    array[index] = 0;
                });
            },
            chartLast: function (n) {
                n = n || 1;
                var chartData = _chartData.datasets[0].data,
                    ret = [];

                if (chartData.length < n) {
                    n = chartData.length;
                }

                ret[0] = chartData.slice(chartData.length - n, chartData.length)
                    .reverse();

                chartData = _chartData.datasets[1].data;
                ret[1] = chartData.slice(chartData.length - n, chartData.length)
                    .reverse();

                return ret;
            },
            last: function () {
                return _info;
            }
        };
    }

    function makeController(options) {
        options = options || {};

        return {
            name: '',
            cpu: makeLineChart(options.cpuChartCanvas),
            memory: makeLineChart(options.memoryChartCanvas),
            ethernet: makeStackChart(options.ethernetChartCanvas),
            update: function (data) {
                this.name = data.name;
                this.cpu.update(data.cpu);
                this.memory.update(data.memory);
                this.ethernet.update(data.ethernet);
            },
            reset: function () {
                this.name = '';
                this.cpu.reset();
                this.memory.reset();
                this.ethernet.reset();
            },
            isShow: function () {
                return this.name !== '';
            },
            columns: function (ctrls) {
                // return 12 / total-displaied-controlled
                if (!this.isShow()) {
                    return 12;
                }

                var total = 0;

                angular.forEach(ctrls, function (ctrl) {
                    if (ctrl.isShow()) {
                        total += 1;
                    }
                });

                return 12 / total;
            }
        };
    }

    function updateControllerCharts(controllers, resp) {
        var r_resp = {};

        angular.forEach(resp, function (value, key) {
            // unique
            r_resp[value.name] = value;
        });

        // drop existing data if no receiving data for specify controller
        angular.forEach(controllers, function (value, key) {
            if (typeof r_resp[value.name] === 'undefined') {
                // controllers[key].name = '';
                controllers[key].reset();
            }
        });

        angular.forEach(r_resp, function (value, key) {
            var index = controllers.findIndex(function (ctrl) {
                return (ctrl.name === value.name);
            });

            if (index === -1) {
                index = controllers.findIndex(function (ctrl) {
                    return (ctrl.name === '');
                });
            }

            if (index === -1) {
                // something error...
                console.log('something error...');
                return;
            }

            controllers[index].update(value);
        });

        // angular.forEach(controllers, function(value, key) {
        //     if (typeof r_resp[value.name] === 'undefined') {
        //         controllers[key].name = '';
        //     }
        // });
    }

    function makeControllerUtilization(name) {
        return {
            name: name,
            cpu: {
                utilization: 15,
                frequencyInGhz: 2.20
            },
            memory: {
                utilization: 51,
                totalInGb: 4,
                usedInGb: 1.5
            },
            ethernet: {
                transmitInKbps: 50,
                receiveInKbps: 55
            }
        };
    }

    var origMakeChart = makeChart;
    makeChart = mockMakeChart;
    function mockMakeChart(ctx, opt) {
        return {
            update: function () {
            }
        };
    }

    var assert = chai.assert;

    //    (function test_for_init() {
    //        var controllers = [
    //                makeController(), makeController(), makeController()
    //            ],
    //            respCtrl1 = makeControllerUtilization('ctrl1'),
    //            respCtrl2 = makeControllerUtilization('ctrl2'),
    //            resp = {
    //                status: 200,
    //                dashboardControllers: [
    //                    respCtrl1, respCtrl2
    //                ]
    //            };
    //
    //        updateControllerCharts(controllers, resp.dashboardControllers);
    //
    //        assert.equal(respCtrl1.name, controllers[0].name);
    //        assert.deepEqual(respCtrl1.cpu, controllers[0].cpu.last());
    //        assert.deepEqual(respCtrl1.memory, controllers[0].memory.last());
    //        assert.deepEqual(respCtrl1.ethernet, controllers[0].ethernet.last());
    //        assert.equal(respCtrl2.name, controllers[1].name);
    //    })();

    makeChart = origMakeChart;

    var app = angular.module('myApp', []);
    app.controller('myCtrl', ['$scope', '$interval', function($scope, $interval) {
        $scope.controllers = [
            makeController({
                cpuChartCanvas: 'controller-1-cpu-chart',
                memoryChartCanvas: 'controller-1-memory-chart',
                ethernetChartCanvas: 'controller-1-ethernet-chart'
            }),
//        makeController({
//            cpuChartCanvas: document.getElementById("controller-2-cpu-chart"),
//            memoryChartCanvas: document.getElementById("controller-2-memory-chart"),
//            ethernetChartCanvas: document.getElementById("controller-2-ethernet-chart")
//        }),
//        makeController({
//            cpuChartCanvas: document.getElementById("controller-3-cpu-chart"),
//            memoryChartCanvas: document.getElementById("controller-3-memory-chart"),
//            ethernetChartCanvas: document.getElementById("controller-3-ethernet-chart")
//        })
        ];

        $interval(function () {
            var randomInt = function (min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            };

            var rangeValue = function (min, max, value) {
                if (value < min) {
                    return min;
                }

                if (max < value) {
                    return max;
                }

                return value;
            };

            var resp = [{
                name: 'controller1',
                cpu: {
                    utilization: rangeValue(0, 100, $scope.controllers[0].cpu.chartLast()[0] + randomInt(10, -10)),
                    frequencyInGhz: 2.20
                },
                memory: {
                    utilization: rangeValue(0, 100, $scope.controllers[0].memory.chartLast()[0] + randomInt(3, -3)),
                    totalInGb: 4,
                    usedInGb: 1.5
                },
                ethernet: {
                    transmitInKbps: rangeValue(0, 100, $scope.controllers[0].ethernet.chartLast()[0][0] + randomInt(10, -10)),
                    receiveInKbps: rangeValue(0, 100, $scope.controllers[0].ethernet.chartLast()[1][0] + randomInt(10, -10))
                }
            }];

            // FIXME: bad ...
//            $('#controller-1-name').text(resp[0].name);
//            $('#controller-1-cpu-value').text('' + resp[0].cpu.utilization + '%');

            updateControllerCharts($scope.controllers, resp);
        }, 50);
    }]);

    var randomScalingFactor = function() { return Math.round(Math.random()*1000) };

    var controller1CpuChartData = {
        labels: [],
        datasets: [{
            pointRadius: 0,
            fillColor: "rgba(220,220,220,0)",
            strokeColor: "rgba(220,180,0,1)",
            pointColor: "rgba(220,180,0,1)",
            label: 'CPU',
            data: []
        }]
    };

    var controller1CpuChartOption = {
        type: 'line',
        data: controller1CpuChartData,
        options: {
            animation : false,
            scales: {
                xAxes: [{
                    display: false
                }],
                yAxes: [{
                }]
            },
            legend: {
                display: false
            },
            tooltips: {
                callbacks: {
                    label: function(tooltipItem) {
                        //console.log(tooltipItem);
                        return tooltipItem.yLabel;
                    }
                }
            }
        }
    };

    var controller1MemChartData = {
        labels: [],
        datasets: [{
            pointRadius: 0,
            fillColor: "rgba(220,220,220,0)",
            strokeColor: "rgba(220,180,0,1)",
            pointColor: "rgba(220,180,0,1)",
            label: 'Memory',
            data: []
        }]
    };

    var controller1MemChartOption = {
        type: 'line',
        data: controller1MemChartData,
        options: {
            animation : false,
            scales: {
                xAxes: [{
                    display: false
                }],
                yAxes: [{
                }]
            },
            legend: {
                display: false
            },
            tooltips: {
                callbacks: {
                    label: function(tooltipItem) {
                        //console.log(tooltipItem);
                        return tooltipItem.yLabel;
                    }
                }
            }
        }
    };

    var controller1EthChartData = {
        labels: [],
        datasets: [{
            pointRadius: 0,
            fillColor: "rgba(220,220,220,0)",
            strokeColor: "rgba(220,180,0,1)",
            pointColor: "rgba(220,180,0,1)",
            label: 'Send',
            data: []
        }, {
            pointRadius: 0,
            fillColor: "rgba(151,187,205,0)",
            strokeColor: "rgba(151,187,205,1)",
            pointColor: "rgba(151,187,205,1)",
            label: 'Receive',
            data: []
        }]
    };

    var controller1EthChartOption = {
        type: 'line',
        data: controller1EthChartData,
        options: {
            animation : false,
            scales: {
                xAxes: [{
                    display: false,
                    stacked: true
                }],
                yAxes: [{
                    stacked: true
                }]
            }
        }
    };

    var i;

    for (i = 0; i < 60; i++) {
        controller1CpuChartData.labels.push('');
        controller1CpuChartData.datasets[0].data.push(0);

        controller1MemChartData.labels.push('');
        controller1MemChartData.datasets[0].data.push(0);

        controller1EthChartData.labels.push('');
        controller1EthChartData.datasets[0].data.push(0);
        controller1EthChartData.datasets[1].data.push(0);
    }

    var controller = [{
    }];

    window.onload = function() {

        var ctx = document.getElementById("controller-2-cpu-chart").getContext("2d");
        controller[0].cpuChart = new Chart(ctx, controller1CpuChartOption);

        ctx = document.getElementById("controller-2-memory-chart").getContext("2d");
        controller[0].memChart = new Chart(ctx, controller1MemChartOption);

        ctx = document.getElementById("controller-2-ethernet-chart").getContext("2d");
        controller[0].ethChart = new Chart(ctx, controller1EthChartOption);

        function dData() {
            return Math.round(Math.random() * 90) + 10;
        }

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        var cpuDataNum = 0;
        setInterval(function() {
            var data, value, value2;

            data = controller1CpuChartData.datasets[0].data;
            data.forEach(function (el, index, array) {
                if (index !== 0) {
                    array[index - 1] = el;
                }
            });
            value = data[ data.length - 1 ] = dData();

            $("#controller-2-cpu-value").text('' + value + '% 2.20 GHz');
            controller[0].cpuChart.update();

            data = controller1MemChartData.datasets[0].data;
            data.forEach(function (el, index, array) {
                if (index !== 0) {
                    array[index - 1] = el;
                }
            });
            value = data[ data.length - 1 ] = dData();

            controller[0].memChart.update();
            $("#controller-2-memory-value").text('' + (value*4)/100 + '/4 GB (' + value + '%)');

            data = controller1EthChartData.datasets[0].data;
            data.forEach(function (el, index, array) {
                if (index !== 0) {
                    array[index - 1] = el;
                }
            });
            value = data[ data.length - 1 ] = dData();

            data = controller1EthChartData.datasets[1].data;
            data.forEach(function (el, index, array) {
                if (index !== 0) {
                    array[index - 1] = el;
                }
            });
            value2 = data[ data.length - 1 ] = dData();

            controller[0].ethChart.update();
            $("#controller-2-ethernet-value").text('S: ' + value + ' R: ' + value2 + ' Kbps');

        }, 1000);
    };

</script>

</body>
</html>