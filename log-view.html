<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="./node_modules/es5-shim/es5-sham.min.js"></script>
    <script src="./node_modules/es6-shim/es6-sham.min.js"></script>
    <script src="./node_modules/lodash/lodash.min.js"></script>
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
    <!--<script src="./node_modules/chai/chai.js"></script>-->
    <script src="./node_modules/angular/angular.min.js"></script>
    <script src="./node_modules/chart.js/dist/Chart.min.js"></script>
    <script src="./node_modules/d3/d3.min.js"></script>
    <script src="./node_modules/moment/min/moment.min.js"></script>

    <script src="./config.js"></script>
    <script src="./controller-chart.js"></script>
    <script src="./elasticsearch.angular.js"></script>
    <script src="app/services/essearch.js"></script>
    <script src="app/services/event-stats-bar.js"></script>

    <link href="./node_modules/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
    <link href="./node_modules/bootstrap/dist/css/bootstrap-theme.css.map" rel="stylesheet">
    <script src="./node_modules/bootstrap/dist/js/bootstrap.min.js"></script>

    <style>
        #ov-event-view .controller > .panel-body {
            height: 360px;
        }

        #ov-event-view .row {
            padding-bottom: 5px;
        }

        .controller-text {
            padding-left: 5px;
            padding-right: 10px;
        }

        .controller-text span {
            font-size: 90%;
            font-weight: 700;
        }

        .controller-text :nth-child(1) {
            font-weight: 400;
        }

        #ov-event-view .chat ul {
            list-style: none;
            /*margin: -15px;*/
            /*padding: 15px;*/
            padding: unset;
            padding-left: 5px;
        }

        #ov-event-view .chat .chat-date {
            background-color: #f8f9fa;
            height: 2em;
        }

        #ov-event-view .chat ul li {
            /*margin-bottom: 10px;*/
            /*padding: 15px 5px;*/
            border-bottom: 1px solid #eee;
            padding-top: 8px;
            padding-bottom: 8px;
            padding-left: 16px;
            padding-right: 16px;
        }

        #ov-event-view .chat ul li.danger {
            border-left: solid;
            border-left-width: 0.5em;
            border-left-color: #ed1c24;
        }

        #ov-event-view .chat ul li.warning {
            border-left: solid;
            border-left-width: 0.5em;
            border-left-color: rgb(250, 187, 61);
        }

        /*#ov-dashboard .chat ul li.info {*/
        /*border-left: solid;*/
        /*border-left-width: 0.25em;*/
        /*border-left-color: rgb(250, 187, 61)*/
        /*}*/

        #ov-event-view .chat ul li.left .chat-body {
            margin-left: 10px;
        }

        #ov-event-view .chat ul li.right .chat-body {
            margin-right: 10px;
        }

        #ov-event-view .chat ul li .chat-body p {
            margin: 0;
        }

        #ov-event-view .chat ul .glyphicon {
            margin-right: 5px;
        }

        #ov-event-view .chat .panel-body {
            overflow-y: auto;
            height: 300px;
            padding: unset;
        }

        #ov-event-view .chat-body small {
            margin-left: 5px;
        }

        #ov-event-view .chat-img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 20px;
            color: #fff;
            line-height: 20px;
            text-align: center;
            background: rgba(226, 8, 12, 0.9);
        }

        .m-t-1 {
            margin-top: 1rem;
        }

        .p-t-1 {
            padding-top: 1rem;
        }

        .p-x-1 {
            padding-right: 1rem;
            padding-left: 1rem;
        }

        .p-y-1 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .inline-box {
            display: inline-block;
        }

        /*.p-lr-12 {*/
        /*padding-left: 12px;*/
        /*padding-left: 12px;*/
        /*}*/

        /*.p-t-5 {*/
        /*padding-top: 5px;*/
        /*}*/

        /*.p-t-10 {*/
        /*padding-top: 10px;*/
        /*}*/

        body {
            /*background-color: #EFEFEF;*/
            background-color: #e4e5e6;
        }

        #ov-event-view .panel {
            border-radius: 0;
            box-shadow: 0 2px 5px 0 rgba(0,0,0,0.26);
            margin-bottom: 18px;
        }

        #ov-event-view .panel-heading {
            background-color: #f8f9fa;
        }

        .search-container .search-input-group {
            /*box-shadow: 0px 2px 2px 0px rgba(0,0,0,0.16), 0px 0px 0px 1px rgba(0,0,0,0.08);*/
            outline-color: #d1d4d7;
            outline-width: 1px;
            outline-style: solid;
        }

        #ov-event-view #search-result-detail {
            border-radius: 0;
            box-shadow: none;
        }

        /*.search-container:hover {*/
        /*box-shadow: 0px 3px 8px 0px rgba(0,0,0,0.2), 0px 0px 0px 1px rgba(0,0,0,0.08);*/
        /*}*/

        .search-container .search-input-group-focus {
            /*box-shadow: 0px 3px 8px 0px rgba(0,0,0,0.2), 0px 0px 0px 1px rgba(0,0,0,0.08);*/
            outline-color: rgba(0, 122, 204, 0.4);
            outline-width: 1px;
            outline-style: solid;
        }

        .search-container .search-input-group input {
            border: none;
            box-shadow: none;
        }

        .search-container .search-input-group input:focus {
            box-shadow: none;
        }

        .search-container .search-input-group button {
            border: none;
        }

        .progress-rect {
            fill: #0e70c0;
        }
    </style>
</head>

<body>
<div ng-app="myApp">
    <div ng-controller="eventViewCtrl">
        <div id="ov-event-view" class="container">
            <div style="margin-top: 18px" />

            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="row p-x-1">
                        <div class="dropdown inline-box">
                            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                refreshed every {{refreshInterval()}}
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                                <!--<li><a href="#" ng-click="setRefreshInterval('1s')">1 seconds</a></li>-->
                                <li><a href="#" ng-click="setRefreshInterval('5s')">5 seconds</a></li>
                                <li><a href="#" ng-click="setRefreshInterval('30s')">30 seconds</a></li>
                                <li><a href="#" ng-click="setRefreshInterval('1m')">1 minutes</a></li>
                            </ul>
                        </div>

                        <button type="button" class="btn btn-default" ng-class="makeAutoRefreshClass()"
                                ng-click="toggleRefresh()">
                            <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                        </button>

                        <div class="dropdown inline-box">
                            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu2"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                DEBUG: Progress bar status, value {{progressBar.value()}} width: {{progressBar.width()}}
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                                <li><a href="#" ng-click="progressBar.value(0)">0%</a></li>
                                <li><a href="#" ng-click="progressBar.value(10)">10%</a></li>
                                <li><a href="#" ng-click="progressBar.value(50)">50%</a></li>
                                <li><a href="#" ng-click="progressBar.value(100)">100%</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="panel-body">
                    <div class="row p-x-1">
                        <div class="search-container">
                            <div class="search-input-group input-group">
                                <input type="text" class="form-control" placeholder="Search for..."
                                       ng-model="searchOptions.q"
                                       ng-keypress="onSearchKeyPressed($event)">
                                <span class="input-group-btn">
                                <button type="button" class="btn btn-default" ng-click="search()">
                                    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                                </button>

                                <button type="button" class="btn btn-default"
                                        ng-click="addTermFn(searchOptions, searchOptions.q)">
                                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                                </button>

                                <button type="button" class="btn btn-default" ng-click="toggleSearchOptions()">
                                    <span class="glyphicon glyphicon-option-vertical" aria-hidden="true"></span>
                                </button>

                            </span>
                            </div><!-- /input-group -->

                            <script>
                                $('.search-container input').focus(
                                    function () {
                                        $(this).parent('div').addClass('search-input-group-focus');
                                    }).blur(
                                    function () {
                                        $(this).parent('div').removeClass('search-input-group-focus')
                                    });
                            </script>

                            <div id="progress-bar" style="line-height: 10px"></div>

                            <div class="btn-group" ng-show="searchOptions.terms.length">
                                <button class="btn btn-default btn-sm" aria-label="Left Align" type="button"
                                        ng-repeat="i in searchOptions.terms"
                                        ng-click="removeTermFn(searchOptions, i)">
                                    <span class="glyphicon glyphicon-remove" aria-hidden="true"> {{i}}</span>
                                </button>
                            </div>

                            <div id="search-options" ng-show="isShowSearchOptions()">

                                <div class="p-t-1">
                                </div>

                                <div class="row p-x-1">
                                    <div class="col-xs-3 col-md-3">
                                        <span>Event Log</span>
                                    </div>
                                    <div class="col-xs-9 col-md-9">
                                        <div class="btn-group">
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.type == 'All' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({type: 'All'})">All
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.type == 'System' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({type: 'System'})">System
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.type == 'Fabric' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({type: 'Fabric'})">Fabric
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="row p-x-1">
                                    <div class="col-xs-3 col-md-3">
                                        <span>Event Severity Levels</span>
                                    </div>
                                    <div class="col-xs-9 col-md-9">
                                        <div class="btn-group">
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.severity == 'All' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({severity: 'All'})">All
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.severity == 'Emerg' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({severity: 'Emerg'})">Emerg
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.severity == 'Alert' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({severity: 'Alert'})">Alert
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.severity == 'Crit' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({severity: 'Crit'})">Crit
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.severity == 'Err' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({severity: 'Err'})">Err
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.severity == 'Warning' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({severity: 'Warning'})">Warning
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.severity == 'Notice' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({severity: 'Notice'})">Notice
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.severity == 'Info' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({severity: 'Info'})">Info
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.severity == 'Debug' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({severity: 'Debug'})">Debug
                                            </button>
                                        </div>
                                    </div>
                                </div> <!-- row -->

                                <div class="row p-x-1">
                                    <div class="col-xs-3 col-md-3">
                                        <span>Time Period</span>
                                    </div>
                                    <div class="col-xs-5 col-md-5">
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="Time Period (Required)"
                                                   ng-model="searchOptions.timePeriod">
                                            <span class="input-group-btn">
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.timePeriodUnit == 'Minutes' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({timePeriodUnit: 'Minutes'})">Minutes
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.timePeriodUnit == 'Hours' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({timePeriodUnit: 'Hours'})">Hours
                                            </button>
                                            <button type="button" class="btn"
                                                    ng-class="searchOptions.timePeriodUnit == 'Days' ? 'btn-info' : 'btn-default'"
                                                    ng-click="setSearchOptionsAndSearch({timePeriodUnit: 'Days'})">Days
                                            </button>
                                        </span>
                                        </div><!-- /input-group -->
                                    </div>
                                </div> <!-- row -->

                            </div> <!-- search-options -->
                        </div> <!-- search-container -->
                    </div>
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="row p-x-1">
                        <div style="width: 100%; height: 100px">
                            <canvas class="main-chart" id="event-stats-chart" width="600" height="150"></canvas>
                        </div>
                    </div> <!-- result-chart -->
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="row p-x-1">
                        <div class="col-xs-3 col-md-3">
                        </div>
                        <div class="col-xs-9 col-md-9">
                            <span>{{searchResult.items.length}} of {{searchResult.stats.total}} results</span>
                        </div>
                    </div> <!-- result-stats -->

                    <div class="row p-x-1">
                        <div class="col-xs-8 col-md-8">
                            <div id="search-result-detail" class="panel panel-default chat">
                                <div id="event-view" class="panel-body">
                                    <ul>
                                        <div ng-repeat="items in searchResult.itemsPerDay">
                                            <div>
                                                <div class="chat-date"
                                                    ng-show="(items.data | filter: eventFilter(filterOptions)).length">
                                                    <span>{{items.date}}</span>
                                                </div>
                                                <div ng-repeat="i in items.data | filter: eventFilter(filterOptions) track by $index">
                                                    <li class="left clearfix" ng-class="makeEventListClass(i._source)">
                                                        <div class="chat-body clearfix">
                                                            <div class="header">
                                                                <strong class="primary-font">{{$index+1}},{{i._id}}
                                                                    {{i._source.address}}</strong>
                                                                <!--<small class="text-muted">{{i._source.localeDateTime}}</small>-->
                                                                <small class="text-muted">{{friendlyDateString(i._source.localeDateTime)}}</small>
                                                            </div>
                                                            <p>
                                                                facility: <strong
                                                                    class="primary-font">{{i._source.facility}}</strong>
                                                                severity: <strong
                                                                    class="primary-font">{{i._source.severity}}</strong>
                                                                tag: <strong class="primary-font">{{i._source.tag}}</strong>
                                                            </p>
                                                            <span>{{i._source.message}}</span>
                                                        </div>
                                                    </li>
                                                </div>

                                                <button type="button" class="btn btn-default center-block m-t-1"
                                                        ng-show="$last && haveMore()"
                                                        ng-click="loadMore()">
                                                    <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                                                    Load More...
                                                </button>
                                            </div>
                                        </div>
                                    </ul>
                                </div>
                                <!--<div class="panel-footer">EVENT</div>-->
                            </div>
                        </div> <!-- event-pane -->

                        <div class="col-xs-4 col-md-4">
                            <h4>Filter by:</h4>

                            <h4>Severity</h4>
                            <div ng-repeat="i in searchResult.stats.severities.buckets | orderBy: 'key'">
                                <div class="checkbox">
                                    <label><input type="checkbox" value=""
                                                  ng-click="onFilterCheckbox(filterOptions.severities, i.key)">{{
                                        severityString(i.key) }} ({{i.doc_count}})</label>
                                </div>
                            </div>

                            <h4>Tag</h4>
                            <div ng-repeat="i in searchResult.stats.tags.buckets">
                                <div class="checkbox">
                                    <label><input type="checkbox" value=""
                                                  ng-click="onFilterCheckbox(filterOptions.tags, i.key)">{{i.key}}
                                        ({{i.doc_count}})</label>
                                </div>
                            </div>

                            <!--<h4>Hostname</h4>-->
                            <!--<div ng-repeat="i in searchResult.stats.hostnames.buckets">-->
                            <!--<div class="checkbox">-->
                            <!--<label><input type="checkbox" value="">{{i.key}} ({{i.doc_count}})</label>-->
                            <!--</div>-->
                            <!--</div>-->

                            <h4>IP Address</h4>
                            <div ng-repeat="i in searchResult.stats.addresses.buckets">
                                <div class="checkbox">
                                    <label><input type="checkbox" value=""
                                                  ng-click="onFilterCheckbox(filterOptions.address, i.key)">{{i.key}}
                                        ({{i.doc_count}})</label>
                                </div>
                            </div>

                        </div>
                    </div> <!-- result-detail -->
                </div>
            </div>

            <div id="debug-pane" class="panel panel-default">
                <div class="panel-heading">
                    <button type="button" class="btn btn-default" style="display: block; margin-left: auto; margin-right: 0px"
                            ng-init="debugMode=true"
                            ng-click="debugMode=!debugMode">
                        <span class="glyphicon" aria-hidden="true"
                              ng-class="debugMode ? 'glyphicon-menu-up' : 'glyphicon-menu-down'"></span>
                    </button>
                </div>
                <div class="panel-body" ng-show="debugMode">
                    <div class="row">
                        <div class="col-xs-8 col-md-8">
                            <div class="row">
                                <div class="col-xs-6 col-md-6">
                                    <pre>scrolled: {{scrolled}}</pre>
                                </div>
                                <div class="col-xs-6 col-md-6">
                                    <pre>searchProgressing: {{searchProgressing}}</pre>
                                </div>
                            </div>
                            <pre style="height: 200px">{{searchResult.items | prettyJSON}}</pre>
                        </div>

                        <div class="col-xs-4 col-md-4">
                            <pre style="height: 250px">{{searchResult.stats | prettyJSON}}</pre>
                        </div>
                    </div>
                </div>
            </div> <!-- debug-pane -->
        </div>
    </div> <!-- eventViewCtrl -->
</div> <!-- myApp -->

<script>

//    moment.locale('zh-tw');
    var app = angular.module('myApp', ['elasticsearch']);

    app.filter('prettyJSON', function () {
        function prettyPrintJson(json) {
            return JSON ? JSON.stringify(json, null, '  ') : 'your browser doesnt support JSON so cant pretty print';
        }

        return prettyPrintJson;
    });

    app.config(function ($httpProvider) {
        $httpProvider.defaults.useXDomain = true;
        delete $httpProvider.defaults.headers.common['X-Requested-With'];
    });

    app.service('client', function (esFactory) {
        return esFactory({
            host: config.elasticsearch.url,
            apiVersion: '2.3',
            log: 'trace'
        });
    });

    (function () {
        'use strict';

        function RefreshCtrl(options) {
            options = options || {};

            if (typeof options.intervalFn !== 'function') {
                throw new Error('intervalFn is required');
            }

            if (typeof options.hookFn !== 'function') {
                throw new Error('hookFn is required');
            }

            // plugin
            var intervalFn = options.intervalFn,
                hookFn = options.hookFn;

            var self = (function init(options) {
                var opts = {
                    enabled: false,
                    interval: 1000, // unit: ms

                    // inner status
                    timer: null
                };

                if (typeof options.interval !== 'undefined') {
                    opts.interval = options.interval;
                }

                if (typeof options.enabled !== 'undefined') {
                    opts.enabled = options.enabled;
                }

                return opts;
            })(options);

            if (self.enabled) {
                start();
            }

            function getInterval() {
                return self.interval;
            }

            function parseInterval(str) {
                var unit = str.substr(str.length - 1),
                    int = str.substr(0, str.length - 1),
                    ms = parseInt(int, 10);

                if (unit === 's') {
                    ms *= 1000;
                } else if (unit === 'm') {
                    ms *= 1000000;
                } else {
                    throw new TypeError('Invalid interval value ' + str);
                }

                return ms;
            }

            function intervalPrettyString(interval) {
                if (interval < 60000) {
                    return '' + (interval / 1000) + 's';
                } else {
                    return '' + (interval / 1000000) + 'm';
                }
            }

            function setInterval(value) {
                if (typeof value === 'string') {
                    value = parseInterval(value);
                }

                if (self.interval === value) {
                    return;
                }

                self.interval = value;
                if (self.enabled) {
                    restart();
                }
            }

            function getEnabledStatus() {
                return self.enabled;
            }

            function restart() {
                stop();
                start();
            }

            function start() {
                console.log('start refresh');
                if (self.timer) {
                    throw new Error('coding defect, self.timer should be null');
                }

                self.timer = intervalFn(hookFn, self.interval);
            }

            function stop() {
                console.log('stop refresh');
                if (self.timer) {
                    intervalFn.cancel(self.timer);
                    self.timer = null;
                }
            }

            function setEnabledStatus(value) {
                console.log('set enabled status from ' + (self.enabled ? 'true' : 'false') + ' to ' + (value ? 'true' : 'false'));

                if (value === true) {
                    start();
                } else {
                    stop();
                }

                self.enabled = value;
            }

            return {
                toggle: function () {
                    var enabled = this.enabled();
                    enabled = !enabled;

                    console.log('toggle status to ' + (enabled ? 'true' : 'false'));

                    this.enabled(enabled);
                },
                interval: function (value) {
                    if (typeof value === 'undefined') {
                        return getInterval();
                    } else {
                        setInterval(value);
                    }
                },
                intervalPrettyString: function () {
                    var interval = this.interval();

                    return intervalPrettyString(interval);
                },
                enabled: function (value) {
                    if (typeof value === 'undefined') {
                        return getEnabledStatus();
                    } else {
                        return setEnabledStatus(value);
                    }
                }
            }
        }

        function SearchWrapper(options) {
            options = options || {};

            if (typeof options.client !== 'object') {
                throw new Error('intervalFn is required');
            }

            var get = ESSearch(options.client),
                req;

            var self = {
                searchResult: {
                    items: [],
                    stats: {},
                    finished: false
                },
                listeners: {
                    begin: [],
                    more_begin: [],
                    updated: []
                }
            };

            function genSearchReq(options) {
                options = options || {};

                function makeAggsReg() {
                    return {
//                        avg_severity: {
//                            avg: {
//                                field: 'severity'
//                            }
//                        },
                        severities: {
                            terms: {
                                field: 'severity'
                            }
                        },
                        tags: {
                            terms: {
                                field: 'tag'
                            }
                        },
                        hostnames: {
                            terms: {
                                field: 'hostname'
                            }
                        },
                        addresses: {
                            terms: {
                                field: 'address'
                            }
                        },
                        event_time_min: {
                            min: {
                                field: 'time'
                            }
                        },
                        event_time_max: {
                            max: {
                                field: 'time'
                            }
                        },
                        event_over_time: {
                            date_histogram: {
                                field: 'time',
                                interval: 'day'
                            }
                        }
                    };
                }

                var uiConvertor = {
                    type: function (text) {
                        if (text === 'System') {
                            return 'test';
                        } else if (text === 'Fabric') {
                            return 'foo';
                        }

                        return '';
                    },
                    dateRangeUnit: function (text) {
                        if (text === 'Minutes') {
                            return 'm';
                        } else if (text === 'Hours') {
                            return 'h';
                        } else if (text === 'Days') {
                            return 'd';
                        }

                        return 'd';
                    }
                };

                function severityStringToNumber(str) {
                    var severity = {
                        fullText: {
                            'Emergency': 0,
                            'Alert': 1,
                            'Critical': 2,
                            'Error': 3,
                            'Warning': 4,
                            'Notice': 5,
                            'Informational': 6,
                            'Debug': 7
                        },
                        keyword: {
                            'Emerg': 0,
                            'Alert': 1,
                            'Crit': 2,
                            'Err': 3,
                            'Warning': 4,
                            'Notice': 5,
                            'Info': 6,
                            'Debug': 7
                        }
                    };

                    if (typeof severity.fullText[str] !== 'undefined') {
                        return severity.fullText[str];
                    }

                    return severity.keyword[str];
                }

                function makeQueryReg(options) {
                    var req = {
                        bool: {
                            must: []
                        }
                    };

//                req.bool.must.push({
//                    term: {
//                        message: 'failed'
//                    }
//                });

                    // OR operations
                    var terms_should = {
                        bool: {
                            should: []
                        }
                    };

                    options.q = options.q.trim();
                    if (options.q && _.indexOf(options.terms, options.q) === -1) {
                        terms_should.bool.should.push({
                            term: {
                                message: options.q
                            }
                        });
                    }

                    angular.forEach(options.terms, function (value) {
                        var s = value.trim();

                        if (!s) {
                            return;
                        }

                        terms_should.bool.should.push({
                            term: {
                                message: value
                            }
                        });
                    });

                    if (terms_should.bool.should.length) {
                        req.bool.must.push(terms_should);
                    }

//                req.bool.must.push({
//                    bool: {
//                        should: [
//                            {
//                                term: {
//                                    message: 'failed'
//                                }
//                            },
//                            {
//                                term: {
//                                    message: 'remote'
//                                }
//                            }
//                        ]
//                    }
//                });

                    if (options.severity !== 'All') {
                        req.bool.must.push({
                            term: {
                                severity: severityStringToNumber(options.severity)
                            }
                        });
                    }

                    function convertDateRange(options) {
                        return {
                            //gte: 'now-' + options.timePeriod + uiConvertor.dateRangeUnit(options.timePeriodUnit) + '/' + uiConvertor.dateRangeUnit(options.timePeriodUnit),
                            //lt: 'now' + '/' + uiConvertor.dateRangeUnit(options.timePeriodUnit)
                            gte: 'now-' + options.timePeriod + uiConvertor.dateRangeUnit(options.timePeriodUnit),
                            lt: 'now'
                        }
                    }

                    req.bool.must.push({
                        range: {
                            time: convertDateRange(options)
                        }
                    });

                    return req;
                }

                var req = {
                    size: options.fetchSize,
                    maxSize: options.pageSize,
                    body: {
                        query: makeQueryReg(options),
                        aggs: makeAggsReg(options)
                    }
                };

                if (typeof options.index === 'string') {
                    req.index = options.index;
                }

                if (options.type !== 'All') {
                    req.type = uiConvertor.type(options.type);
                }

                return req;
            }

            function respCb(err, resp) {
                if (err) {
                    // FIXME: should consider the error case
                    self.searchResult.last = true;
                    self.listeners.updated[0](err, self.searchResult);
                    return;
                }

                self.searchResult.items = _.cloneDeep(resp.hits.hits);

                if (resp.aggregations) {
                    self.searchResult.stats = _.cloneDeep(resp.aggregations);
                    self.searchResult.stats.total = resp.hits.total;

                    self.searchResult.first = true;
                } else {
                    self.searchResult.first = false;
                }

                self.searchResult.last = this.$scope.last;

                self.listeners.updated[0](null, self.searchResult);
            }

            return {
                searchResult: function () {
                    return self.searchResult;
                },
                search: function (options) {
                    self.searchResult = {
                        items: [],
                        stats: {},
                        finished: false
                    };

                    req = genSearchReq(options);

                    self.listeners.begin[0](req);

                    get(req, respCb);

                    return this;
                },
                more: function () {
                    self.searchResult = {
                        items: [],
                        stats: {},
                        finished: false
                    };

                    req.$scope.climb = 0;

                    self.listeners.more_begin[0](req);

                    get(req, respCb);

                    return this;
                },
                on: function (type, cb) {
                    if (type === 'begin') {
                        self.listeners.begin.push(cb.bind(this));
                    } else if (type === 'more_begin') {
                        self.listeners.more_begin.push(cb.bind(this));
                    } else if (type === 'updated') {
                        self.listeners.updated.push(cb.bind(this));
                    } else {
                        throw new TypeError('invalid type ' + type);
                    }

                    return this;
                }
            }
        }

        function ProgressBar(options) {
            options = options || {};

            var height = 5,
                logger = function () {
                };

            if (typeof options.id !== 'string') {
                throw new Error('id is required');
            }

            if (options.log) {
                if (typeof options.log === 'function') {
                    logger = options.log;
                }
                else if (typeof options.log === 'string' && options.log === 'trace') {
                    logger = console.log;
                }
            }

            var svg = d3.select(options.id)
                .append('svg')
                .attr('height', height)
                .attr('width', '100%');

            svg.append('rect')
                .attr('class', 'bg-rect')
                .attr('rx', 0)
                .attr('ry', 0)
                .attr('opacity', 0)
                .attr('height', height)
                .attr('width', '100%')
                .attr('x', 0)
                .attr('y', 0);

            var progress = svg.append('rect')
                .attr('class', 'progress-rect')
                .attr('opacity', 1)
                .attr('height', height)
                .attr('width', 0)
                .attr('rx', 0)
                .attr('ry', 0)
                .attr('x', 0)
                .attr('y', 0);

            var self = {
                value: 0,
                max: 100,
                listeners: {
                    end: []
                }
            };

            setValue(self.value);

            function width(el) {
                if (typeof el === 'undefined') {
                    el = svg;
                }

                return el.node().getBBox().width;
            }

            function dispatchEvent(type) {
                if (typeof self.listeners[type] === 'undefined') {
                    throw new TypeError('invalid listener type');
                }

                self.listeners[type].forEach(function (fn) {
                    fn();
                });

                self.listeners[type] = [];
            }

            function finalize() {
                progress.transition()
                    .duration(300)
                    .attr('opacity', 0)
                    .each('end', (function (value) {
                        dispatchEvent('end');
                    }))
                    .each('interrupt', (function (value) {
                        dispatchEvent('end');
                    }))
            }

            function getValue() {
                return self.value;
            }

            function setValue(value, immediately) {
                self.value = value;

                if (immediately) {
                    progress.attr('width', function () {
                        return (self.value / self.max) * width(svg);
                    });
                } else {
                    logger('progress-bar: setValue(' + value + ')');

                    var progressTrans = progress.transition()
                        .duration(50)
                        .attr('width', function () {
                            logger('progress-bar: width = ' + (self.value / self.max) * width(svg));
                            return (self.value / self.max) * width(svg);
                        });

                    if (d3.version[0] === '3') {
                        progressTrans
                            .each('end', (function (value) {
                                return function () {
                                    logger('progress-bar: setValue(' + value + ') finished');

                                    if (value === self.max) {
                                        finalize();
                                    }
                                }
                            })(value))
                            .each('interrupt', (function (value) {
                                return function () {
                                    logger('progress-bar: setValue ' + value + ' interrupted');
                                }
                            })(value));
                    }
                    else if (d3.version[0] === '4') {
                        progressTrans
                            .on('end', (function (value) {
                                return function () {
                                    logger('progress-bar: setValue ' + value + ' finished');

                                    if (value === self.max) {
                                        finalize();
                                    }
                                }
                            })(value))
                            .on('interrupt', (function (value) {
                                return function () {
                                    logger('progress-bar: setValue ' + value + ' interrupted');
                                }
                            })(value));
                    }
                }
            }

            function getMax() {
                return self.max;
            }

            function setMax(value) {
                self.max = value;
            }

            return {
                reset: function () {
                    progress.attr('width', 0)
                        .attr('opacity', 1);
                    return this;
                },
                value: function (value, immediately) {
                    if (typeof value === 'undefined') {
                        return getValue();
                    } else {
                        setValue(value, immediately);
                        return this;
                    }
                },
                max: function (value) {
                    if (typeof value === 'undefined') {
                        return getMax();
                    } else {
                        setMax(value);
                        return this;
                    }
                },
                width: width,
                on: function (type, cb) {
                    if (type === 'end') {
                        self.listeners.end.push(cb.bind(this));
                    } else {
                        throw new TypeError('invalid type ' + type);
                    }

                    return this;
                }
            }
        }

        app.controller('eventViewCtrl', ['$scope', '$interval', '$http', 'client', function ($scope, $interval, $http, client) {
            $scope.progressBar = ProgressBar({
                id: '#progress-bar',
                //log: console.log
            });

            $scope.showSearchOptions = true;

            $scope.toggleSearchOptions = function () {
                $scope.showSearchOptions = !$scope.showSearchOptions;
            };

            $scope.isShowSearchOptions = function () {
                return $scope.showSearchOptions;
            };

            $scope.searchOptions = _.assignWith({
                fetchSize: 200, // per fetch size
                pageSize: 200,  // one page size
                q: '',
                terms: [],
                type: 'All',
                severity: 'All',
                source: 'All',
                timePeriod: 7,
                timePeriodUnit: 'Days'
            }, config.eventview.searchDetail);

            $scope.filterOptions = {
                severities: [],
                tags: [],
                address: []
            };

            $scope.onFilterCheckbox = function (option, val) {
                var index = _.indexOf(option, val);

                if (index === -1) {
                    option.push(val);
                } else {
                    option.splice(index, 1);
                }
            };

            $scope.eventFilter = function (options) {
                return function (item) {

                    if (_.head(options.severities)) {
                        if (_.indexOf(options.severities, item._source.severity) === -1) {
                            return false;
                        }
                    }

                    if (_.head(options.tags)) {
                        if (_.indexOf(options.tags, item._source.tag) === -1) {
                            return false;
                        }
                    }

                    if (_.head(options.address)) {
                        if (_.indexOf(options.address, item._source.address) === -1) {
                            return false;
                        }
                    }
                    //return item.name === options.name;
                    return true;
                };
            };

            var searchCtrl = SearchWrapper({
                client: client
            });

            var chart = EventStatsBar({
                canvasContext: 'event-stats-chart'
            });

            function updateChart(stats) {
                var data = [];

                var minDate = new Date(stats.event_time_min.value_as_string),
                    maxData = new Date(stats.event_time_max.value_as_string);

                var sameYear = minDate.getFullYear() === maxData.getFullYear();

                angular.forEach(stats.event_over_time.buckets, function (value, key) {

                    var date = new Date(value.key_as_string);

                    if (sameYear) {
                        data.push({
                            label: '' + (date.getMonth() + 1) + '/' + date.getDate(),
                            data: value.doc_count
                        });
                    } else {
                        data.push({
                            label: '' + (date.getMonth() + 1) + '/' + date.getDate() + '/' + date.getFullYear(),
                            data: value.doc_count
                        });
                    }
                });

                chart.update(data);
            }

            $scope.searchResult = {
                items: [],
                stats: {},
                finished: false
            };

            $scope.searchProgressing = false;

            function searchFinished() {
                console.log('search finished');
                $scope.searchProgressing = false;
                $scope.$digest();
            }

            searchCtrl.on('begin', function (req) {
                console.log('search beginning');

                $scope.searchResult = {
                    items: [],
                    itemsPerDay: [],
                    itemsLookupTbl: {},
                    stats: {},
                    finished: false
                };

                $scope.searchProgressing = true;
                $scope.progressBar.on('end', searchFinished);

                $scope.progressBar.max(req.maxSize);
                $scope.progressBar.reset();
                $scope.progressBar.value($scope.progressBar.max() / 200);
            }).on('more_begin', function (req) {
                console.log('search beginning');

                $scope.searchProgressing = true;
                $scope.progressBar.on('end', searchFinished);

                $scope.progressBar.max(req.maxSize);
                $scope.progressBar.reset();
                $scope.progressBar.value($scope.progressBar.max() / 200);
            }).on('updated', function (err, searchResult) {
                $scope.searchResult.items = _.concat($scope.searchResult.items, searchResult.items);

                _.forEach(searchResult.items, function (item) {
                    var date = new Date(item._source.time);
                    var dateString = '' + date.getFullYear() + '/' + (date.getMonth() + 1) + '/' + date.getDate();

                    if (typeof $scope.searchResult.itemsLookupTbl[dateString] === 'undefined') {
                        $scope.searchResult.itemsPerDay.push({date: dateString, data:[]});
                        $scope.searchResult.itemsLookupTbl[dateString] = _.last($scope.searchResult.itemsPerDay).data;
                    }

                    $scope.searchResult.itemsLookupTbl[dateString].push(item);
                });

                if (searchResult.first) {
                    $scope.searchResult.stats = searchResult.stats;
                    updateChart(searchResult.stats);
                }

                if (searchResult.last) {
                    $scope.progressBar.value($scope.progressBar.max());
                } else {
                    $scope.progressBar.value(searchResult.items.length);
                }
            });

            $scope.onSearchKeyPressed = function ($event) {
                var keyCode = $event.which || $event.keyCode;
                if (keyCode === 13) {
                    $scope.search();
                }
            };

            $scope.search = function () {
                if ($scope.searchProgressing === true) {
                    return;
                }

                $scope.searchResult = {
                    items: [],
                    stats: {}
                };

                searchCtrl.search($scope.searchOptions);
            };

            $scope.haveMore = function () {
                if (typeof $scope.searchResult === 'undefined') {
                    return true;
                }

                return $scope.searchResult.items.length < $scope.searchResult.stats.total;
            };

            $scope.loadMore = function () {
                if ($scope.searchProgressing === true) {
                    return;
                }

                if (!$scope.haveMore()) {
                    return;
                }

                searchCtrl.more();
            };

            $scope.setSearchOptionsAndSearch = function (options) {
                if ($scope.searchProgressing === true) {
                    return;
                }

                $scope.searchOptions = _.assignIn($scope.searchOptions, options);
                $scope.search();
            };

            searchCtrl.search($scope.searchOptions);

            $scope.addTermFn = function (options, term) {
                term = String.prototype.trim.call(term);

                if (!term) {
                    return;
                }

                if (_.indexOf(_.slice(options.terms, 1), term) === -1) {
                    options.terms.push(term);

                    // FIXME: bad ...
                    options.q = '';
                }
            };

            $scope.removeTermFn = function (options, term) {
                var idx = _.indexOf(options.terms, term);
                if (idx === -1) {
                    return;
                }

                options.terms.splice(idx, 1);
            };

            var refreshCtrl = RefreshCtrl({
                interval: 5000,
                intervalFn: $interval,
                hookFn: function () {
                    searchCtrl.search($scope.searchOptions);
                }
            });

            $scope.toggleRefresh = refreshCtrl.toggle.bind(refreshCtrl);
            $scope.setRefreshInterval = refreshCtrl.interval.bind(refreshCtrl);
            $scope.refreshInterval = refreshCtrl.intervalPrettyString.bind(refreshCtrl);

            $scope.makeAutoRefreshClass = function () {
                return refreshCtrl.enabled() ? 'btn-info' : '';
            };

            $scope.severityString = function (lvl) {
                var severity = {
                    0: 'Emergency',
                    1: 'Alert',
                    2: 'Critical',
                    3: 'Error',
                    4: 'Warning',
                    5: 'Notice',
                    6: 'Informational',
                    7: 'Debug'
                };

                return severity[lvl];
            };

            $scope.makeEventListClass = function (item) {
                if (item.severity < 4) {
                    return 'danger';
                } else if (item.severity === 4) {
                    return 'warning';
                } else {
                    return 'info';
                }
            };

            $scope.friendlyDateString = function (date) {
                return moment(date).calendar(null, {
                    sameDay: '[Today] A hh:mm:ss',
                    lastDay: '[Yesterday] A hh:mm:ss',
                    lastWeek: 'YYYY/MM/DD A hh:mm:ss'
                });
            };

            $scope.scrolled = false;
            $('#event-view').scroll(function () {
                if ($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
                    $scope.scrolled = true;
                } else {
                    $scope.scrolled = false;
                }
                $scope.$digest();

                // TODO: if max enter is larger than 5000, disable auto load function
                if ($scope.scrolled === true) {
                    $scope.loadMore();
                }
            });
        }]);
    }());

</script>

</body>
</html>